# オンラインコワーキングスペース リファクタリングタスクリスト

このドキュメントは、`docs/refactoring-strategy.md` に基づくリファクタリングの具体的なタスクリストです。

## フェーズ 0: 準備と基盤整備

- [ ] Jest / React Testing Library / Playwright 等のテストフレームワークを導入
- [ ] 基本的なテストカバレッジレポート設定を行う
- [ ] ESLint / Prettier のルールを確認・統一し、CIでのチェックを強制する設定を追加
- [ ] `lib/youtube.js` を `lib/youtube.ts` へ完全に移行・統合する
- [ ] 不要な `.js` ファイル（`lib/youtube.js`, `scripts/test-mongodb-cjs.js` など）を削除
- [ ] `scripts` 内の `.js` ファイルを可能な限り `.ts` へ移行する (`ts-node` を活用)
- [ ] `package.json` を確認し、不要な依存関係を削除
- [ ] 依存関係のバージョンを最新安定版に更新検討

## フェーズ 1: コアロジックの整理と責務分離

### ポモドーロタイマーロジック統合
- [ ] `Header.tsx` と `PomodoroTimer.tsx` のタイマーロジックを分析
- [ ] `PomodoroTimer.tsx` のロジックを主とし、`Header.tsx` の `determineTimeModeFromCurrentTime` 等の複雑な時刻ベース計算を削除または大幅に簡略化
- [ ] 状態管理ライブラリ（Context API, Zustand等）を導入し、Header と PomodoroTimer で状態を共有
- [ ] localStorage への直接依存を減らし、状態管理ライブラリ経由でのアクセスに切り替える

### 自動退室ロジック統合
- [ ] `api/sse/route.ts` 内の定期チェックを主とする方針を決定
- [ ] `api/check-auto-exit/route.ts` を削除または補助的な役割（手動トリガー等）に限定
- [ ] `api/sse/route.ts` 内の自動退室チェックロジックの安定性を向上させる

### YouTubeコメント処理とコマンド実行の分離
- [ ] `api/youtube-comments/route.ts` がコメント取得に専念するように修正 (GETリクエストでのDB更新を削除)
- [ ] **分離戦略の選択と実装:** （以下のどちらかを選択）
    - [ ] **戦略A (バックエンドポーリング):**
        - [ ] 独立したポーリングプロセス (別APIルート or 外部スケジューラ) を実装
        - [ ] 取得コメントを一時的なキュー（Vercel KV or MongoDBコレクション）に入れる処理を実装
        - [ ] キューからコマンドを処理する新しいAPIルート (`api/process-command/route.ts` など) を実装 (DB更新 + YouTube応答)
    - [ ] **戦略B (クライアント起点のPOST):**
        - [ ] `page.tsx` の `setInterval` を維持
        - [ ] `api/youtube-comments` でコメントを取得し、コマンドを検出
        - [ ] コマンド検出後、クライアントから新しい `POST /api/commands` エンドポイントを呼び出すように変更
        - [ ] `POST /api/commands` エンドポイントでDB更新とYouTube応答処理を実装

## フェーズ 2: リアルタイム処理の改善

### SSEハンドラ (`api/sse/route.ts`) のリファクタリング
- [ ] MongoDB Change Stream のエラーハンドリング（再接続ロジック等）を強化
- [ ] 自動退室チェックロジックをより分離し、明確化
- [ ] クライアント切断時のリソースリーク防止ロジック (`isControllerClosed` 周辺) を再確認・簡素化
- [ ] 初期データ送信と変更ストリーム監視のコードを整理・改善

### クライアント側SSEハンドリング (`page.tsx`) の改善
- [ ] `EventSource` のエラーハンドリングと再接続ロジックを堅牢化
- [ ] SSEからのデータ受信・状態更新ロジックをカスタムフック (`useSeatData` など) に抽出
- [ ] `page.tsx` からSSE関連の複雑なロジックを削除し、カスタムフック利用に切り替え

## フェーズ 3: フロントエンドと状態管理の改善

### `page.tsx` の責務軽減
- [ ] SSE接続管理ロジックをカスタムフックやContext Providerに移動
- [ ] YouTubeコメントポーリングロジック（フェーズ1戦略Bの場合）をカスタムフックやContext Providerに移動

### コンポーネント粒度の見直し
- [ ] `FocusRoom.tsx` のアニメーションロジックの複雑性を評価
- [ ] 必要であれば、状態管理ライブラリや専用アニメーションライブラリの利用を検討・導入
- [ ] ドメイン固有ロジックを持つコンポーネント (`UserCard`, `FocusRoom`) の責務が適切か確認・調整

### 状態管理戦略の明確化
- [ ] クライアント側での座席/ルームデータの状態保持・表示更新ロジックを明確化・文書化
- [ ] 必要であれば軽量状態管理ライブラリ（Zustand, Jotai等）の導入を検討・実装
- [ ] グローバル/共有状態を一元管理する仕組みを確立

## フェーズ 4: テストカバレッジ向上

### ユニットテスト
- [ ] `lib/utils.ts` 内のヘルパー関数のユニットテストを作成・拡充
- [ ] `lib/messages.ts` のテンプレート生成関数のユニットテストを作成
- [ ] `UserCard`, `PomodoroTimer` など主要コンポーネントの表示ロジックに関するユニットテストを作成

### インテグレーションテスト
- [ ] APIエンドポイントのテスト環境（Mock Service Worker or Supertest）をセットアップ
- [ ] コマンド処理APIのインテグレーションテストを作成
- [ ] SSE接続とデータフローに関するインテグレーションテストを作成
- [ ] DB操作を含むシナリオのインテグレーションテストを作成
- [ ] フロントエンドとバックエンドを連携させたテストシナリオ（コマンド送信 → UI更新など）を作成

### E2Eテスト (オプション)
- [ ] PlaywrightなどのE2Eテストフレームワークを導入
- [ ] 主要ユーザーフロー（入室、退室、自動退室）のE2Eテストを作成

## フェーズ 5: ドキュメントとクリーンアップ

### ドキュメント更新
- [ ] `docs/` 内のドキュメント（特に `refactoring-strategy.md` や関連文書）をリファクタリング内容に合わせて更新
- [ ] コード内のコメント（JSDoc/TSDoc）を充実させる (特にAPI、複雑なロジック)

### コードクリーンアップ
- [ ] 未使用の変数、関数、インポート、コンポーネントを特定し削除
- [ ] `console.log` 等のデバッグコードを削除または適切なロガーに置き換え
- [ ] `.env.example` ファイルを作成・更新し、必要な環境変数を明記 